name: Deploy to SST Preview

on:
  pull_request:
    types: [opened, synchronize, closed]

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  deploy:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/setup-bun

      - uses: ./.github/actions/setup-aws-sst
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}

      - name: Get short commit sha
        id: meta
        run: |
          echo "short_sha=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Deploy SST
        id: sst-deploy
        run: |
          OUTPUT=$(bun x sst deploy --stage pr-${{ github.event.pull_request.number }} 2>&1)
          echo "$OUTPUT"

          URL=$(echo "$OUTPUT" | grep -oE 'https://[a-z0-9]+\.cloudfront\.net' | head -1)
          echo "url=$URL" >> "$GITHUB_OUTPUT"

      - name: Show preview URL
        run: echo "Deployed to ${{ steps.sst-deploy.outputs.url }}"

      - name: Comment preview
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: sst-preview
          message: |
            **Deployed to AWS**
            <table>
            <tr><td>Latest commit:</td><td>[`${{ steps.meta.outputs.short_sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})</td></tr>
            <tr><td>Status:</td><td>${{ steps.sst-deploy.outcome == 'success' && '✅ Deploy successful!' || '❌ Deploy failed' }}</td></tr>
            <tr><td>Preview URL:</td><td>${{ steps.sst-deploy.outputs.url && format('[Open Preview]({0})', steps.sst-deploy.outputs.url) || 'N/A' }}</td></tr>
            </table>
            [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

  remove:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/setup-bun

      - uses: ./.github/actions/setup-aws-sst
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}

      - run: bun x sst remove --stage pr-${{ github.event.pull_request.number }}
